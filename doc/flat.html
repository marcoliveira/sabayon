<?xml version="1.0"?>
<html>
  <body>
    <h1>Sabayon: User profiles made simple</h1>
    <h3>What is Sabayon?</h3>
    <p>Sabayon is a system administration tool to manage GNOME desktop settings. Sabayon provides a sane way to edit GConf defaults and GConf mandatory keys: the same way you edit your desktop. Sabayon launches profiles in an Xephyr window. Any changes you make in the Xephyr window are saved back to the profile file, which can then be applied to user's accounts.</p>
    <p>More screenshots and a step by step example are available from Seth Nickell <a href="http://www.gnome.org/~seth/blog/sabayon">blog about sabayon 0.12</a>.</p>
    <h3>Features</h3>
    <p>Currently Sabayon is limited to the creation and update of user preference profiles. It does not deal with the very large problem of actually populating target system with those preferences.</p>
    <h3>Supported configuration backend</h3>
    <p> So far Sabayon supports complete files and the configuration format for:</p>
    <ul class="left">
      <li>GConf</li>
      <li>Mozilla/Firefox</li>
    </ul>
    <p> We are looking into or planning on adding support for the following: </p>
    <ul class="left">
      <li>OpenOffice.org</li>
    </ul>
    <h3>More documentation</h3>
    <p> Contributed documentation is welcome: </p>
    <ul class="left">
      <li>Documentation <a href="http://rd.cri74.org/index.php?2005/05/10/11-documentation-sur-sabayon">in French</a> and
      <a href="http://www.rd.cri74.org/repository/gnome/doc_sabayon_v2_english.pdf">English</a> by Philippe Tonguet.</li>
    </ul>
    <h2>
      <a name="helping">Helping with Sabayon</a>
    </h2>
    <h4>Triage Bugzilla</h4>
    <p>Use <a href="http://bugzilla.gnome.org/buglist.cgi?short_desc_type=allwordssubstr&amp;short_desc=&amp;product=sabayon&amp;long_desc_type=allwordssubstr&amp;long_desc=&amp;status_whiteboard_type=allwordssubstr&amp;status_whiteboard=&amp;keywords_type=anywords&amp;keywords=&amp;bug_status=UNCONFIRMED&amp;bug_status=NEW&amp;bug_status=ASSIGNED&amp;bug_status=REOPENED&amp;bug_status=NEEDINFO&amp;bug_status=VERIFIED&amp;emailtype1=substring&amp;email1=&amp;emailtype2=substring&amp;email2=&amp;bugidtype=include&amp;bug_id=&amp;changedin=&amp;chfieldfrom=&amp;chfieldto=Now&amp;chfieldvalue=&amp;cmdtype=doit&amp;namedcmd=bugs+i+watch&amp;newqueryname=&amp;order=Reuse+same+sort+as+last+time&amp;field0-0-0=noop&amp;type0-0-0=noop&amp;value0-0-0=">this link</a> for looking at open bugs with Sabayon.  Please make sure the new and unconfirmed bugs conform the the bug reporting guidelines laid out in the <a href="testing.html">testing</a> section.  </p>
    <p> The GNOME Bugsquad has a good <a href="http://developer.gnome.org/projects/bugsquad/triage/">triage guide</a> for people new to bugzilla and GNOME.  Read up on that before doing any triage work with bugzilla and if you know that please also read our <em>bug reporting guidelines</em> in the <a href="testing.html">testing</a> section.  </p>
    <strong>Distribution Support</strong>
    <p> Sabayon needs as much testing and widespread distribution as
possible in order to become the default preference management tool for
sysadmins in GNOME, replacing the ad hoc solutions that people currently use.</p>
    <p> Ask your favorite distribution to package Sabayon and use it. </p>
    <h2>
      <a name="testing">Testing Sabayon</a>
    </h2>
    <h4>Getting From CVS</h4>
    <p>
    To get the very latest copy of Sabayon you'll need to pull it from CVS.  Here's how you'll do it.
    </p>
    <pre>
    export CVSROOT=':pserver:anonymous@anoncvs.gnome.org:/cvs/gnome'
    cvs login
    [press enter for blank password]
    cvs -z3 co sabayon
    cd sabayon
    </pre>
    <h4>Getting From Package</h4>
    <p>
    Download the latest source package from the Sabayon package directory: <a href="http://ftp.gnome.org/pub/GNOME/sources/sabayon/">http://ftp.gnome.org/pub/GNOME/sources/sabayon/</a>.  Then untar the files like this:
    </p>
    <pre>
    tar -zxvf sabayon-0.1.0.tar.gz
    cd sabayon-0.1.0
    </pre>
    <h4>Building From Source</h4>
    <p>
    Assuming you've changed into the Sabayon source directory from either a package or CVS you now want to start the build.
    </p>
    <pre>
    ./autogen.sh --prefix=/usr/local
    make
    make install (sudo make install may work for you)
    </pre>
    <h4>Environment</h4>
    <p>Check the README file, to test sabayon you need a number of
packages to be up to date. This is checked by the RPM upon installation.
You also need a sabayon user defined like:</p>
    <pre>sabayon:x:50140:99:Sabayon user:/var/sabayon:/sbin/nologin</pre>
    <p>The RPM post install scripts uses the following command to
create this specific user:</p>
    <tt>/usr/sbin/useradd -c "Sabayon user" -d /var/sabayon -g nobody -s /sbin/nologin sabayon </tt>
    <p>You may need to do this by hand or in you package to have a
working installation of sabayon</p>
    <h4>Testing</h4>
    <p>
    Now that you have Sabayon installed try it by launching sabayon
as root and create new profiles and edit them. Don't forget to save
the session before quitting to have the profile updated. Check the step
by step example available from Seth Nickell <a href="http://www.gnome.org/~seth/blog/sabayon">blog about sabayon 0.12</a>.</p>
    <h4>Reporting Bugs</h4>
    <p>
    When reporting bugs about Sabayon it is most helpful to explain the sequence of events you did to generate the bug. If we can reproduce the bug it is
of course easier to fix.</p>
    <p>
    Report bugs for sabayon to GNOME Bugzilla under the <a href="http://bugzilla.gnome.org/enter_bug.cgi?product=sabayon">Sabayon
    product</a>.
    </p>
    <h4>Getting More Help</h4>
    <p>
    The GNOME web site has lots of materials for helping you build packages from source, see the <a href="http://developer.gnome.org/tools/cvs.html">developer site</a> for more information about CVS and autogen and building.  If you have any other questions feel free to direct them to IRC or the mailing list.
    </p>
    <h2>
      <a name="developing">Developing Sabayon</a>
    </h2>
    <p>The <a href="http://cvs.gnome.org/viewcvs/sabayon/AUTHORS?view=auto">AUTHORS</a> file has the current people in charge of the Sabayon project maintenance and development.</p>
    <h4>Getting Started</h4>
    <p>If you'd like to start working on Sabayon see the <a href="testing.html">Testing</a> section for how to get the latest CVS sources of Sabayon.</p>
    <h4>Getting in Touch</h4>
    <p>Sabayon hackers use the <a href="http://mail.gnome.org/mailman/listinfo/sabayon-list/">mailing list</a> and irc channel <em>#sabayon</em> on the server <em>irc.gnome.org</em> for keeping in touch and discussing issues regarding the project.</p>
    <h4>The TODO List</h4>
    <p>Sabayon has a <a href="http://cvs.gnome.org/viewcvs/sabayon/TODO?view=auto">TODO</a> list that should be updated frequently describing the work that the developers would like to undertake and will gladly accept patches for.  </p>
    <h2> <a name="config">The configuration files</a> </h2>
    <p> This page details the format of the user configuration file,
        where to store and access them.</p>
    <h4>The user database</h4>
    <p> This file is located under <b>/etc/desktop-profiles/users.xml</b>
    (see PROFILESDIR in the config.py file to change the prefix), as the name
    makes clear it is an XML file and usually look like:</p>
    <pre>
      &lt;profiles&gt;
        &lt;user name="titeuf" profile="developer"/&gt;
        &lt;user name="fab" profile="developer"/&gt;
        &lt;user name="bianca" profile="secretary"/&gt;
	...
        &lt;default profile="default"/&gt;
      &lt;/profiles&gt;
    </pre>
    <p> It contains a list of named users, and their associated profile.
    The profile in that case are aliases, for example <b>developer</b>
    is a shortcut for <b>developer.zip</b> in the same directory.</p>
    <p> The default profile will be applied for any login not listed 
    explicitely in the set of users. At this point there is no support
    for grouping user definitions in the format, this may be added later
    if there is an unambiguous way to do it.</p>
    <h4>Centralized user databases and profiles</h4>
    <p> For large and automated deployement, maintaining copies of the user
    database and profiles on all machines does not really make sense. To 
    avoid the problem, the profile values can be an URI - preferably using
    HTTP - to reference a remote resource like:</p>
    <pre>        ...
        &lt;user name="titeuf"
	            profile="http://server.corp.com/prof/developers.zip"/&gt;
        &lt;user name="fab"
	            profile="http://server.corp.com/prof/developers.zip"/&gt;
	...
    </pre>
    <p> The profiles should then be maintained on a separate machine and
    copied over to the server when updated.</p>
    <p> The user database can also be centralized, using the
    <a href="http://www.w3.org/TR/xinclude/">XInclude</a> mechanism for XML.
    For example the following assume there is a developer list maintained
    separately on the server, and defining the profiles for
    them:</p>
    <pre>
      &lt;profiles&gt;
        &lt;xi:include xmlns:xi="http://www.w3.org/2001/XInclude"
	      href="http://server.corp.com/user/devel.xml#xpointer(//user)"/&gt;
	...
        &lt;default profile="default"/&gt;
      &lt;/profiles&gt;
    </pre>
    <p> This XInclude will just collect all user definitions in the developer
    list at <b>http://server.corp.com/user/devel.xml</b> and replace the 
    include statement with that list, and process the XML as usual. The only
    difference is that the profile values are then assumed to be URI-References
    and for example if the <b>devel.xml</b> contains</p>:
    <pre>        ...
        &lt;user name="titeuf" profile="../prof/developers.zip"/&gt;
	...
    </pre>
    <p> then sabayon will fetch the profile relative to the location of
    devel.xml, that is it will lookup the profiles relative to the base
    of where the fragment was defined and use
    <b>http://server.corp.com/prof/developers.zip</b>. Also note that
    shortcut are not allowed there, the trailing <b>.zip</b> is needed.</p>
    <p> The last point about the centralized support is that sabayon will
    use a cache located in the user home directory under <b>.sabayon/profile_cache</b>
    to keep a copy of the non-local files, this allows profile to function
    normally in disconnected operations or in case of server failures.</p>
    <h4>LDAP support</h4>
    <p> Sabayon also supports using LDAP to get profiles in a very flexible way.
    Further details <a href="ldap.html">here</a>.</p>
    <h2><a name="ldap">LDAP support</a></h2>
    <p> Sabayon supports using LDAP to get profiles in a very flexible way.
    By defining server settings and queries in the
    <b>/etc/desktop-profiles/users.xml</b> file it can do the mapping from user
     to profile file using LDAP queries. An example setup can look like:</p>
    <pre>
      &lt;profiles&gt;
       &lt;ldap server="ldap.example.com"&gt;
        &lt;profilemap search_base="ou=People,dc=example,dc=com"
                 scope="one"
                 query_filter="(uid=%u)"
                 result_attribute="sabayonProfileURL"/&gt;
        &lt;/ldap&gt;
        &lt;default profile="default"/&gt;
      &lt;/profiles&gt;
    </pre>
    <h4>LDAP server configuration</h4>
    <p>The toplevel ldap tag sets up the server connection. Availible
    attributes are:</p>
    <ul>
      <li>server (default: localhost): The address of the ldap server</li>
      <li>port (default: 389): The port of the ldap server</li>
      <li>version (default: 3): The ldap version to use</li>
      <li>timeout (default: 10): Timeout to use for ldap operations, 0 to disable</li>
      <li>bind_dn: dn to bind as, or leave out to run queries without binding</li>
      <li>bind_pw: password used when binding</li>
    </ul>
    <h4>LDAP queries</h4>
    <p>Inside the ldap tag you can define the two queries used by sabayon. The
    first is the profilemap query, which maps from the username to the profile
    name to use for the user. The profile name is just a string, and it can be
    either an absolute URI, a URI relative to the config file, or just a name.
    If it is a name it will be looked up in the locationmap LDAP query (if specified)
    and if that didn't match, it will be converted to a filename in /etc/desktop-profiles
    by appending ".zip".</p>
    <p>The locationmap query specifies the mapping from profile name to profile
    URI. This can optinally be used instead of storing the profile URI directly
    in the LDAP user object, to allow more flexibility in changing the URI.</p>
    <p>Both queries support these attributes:</p>
    <ul>
     <li>search_base: The search base of the query</li>
     <li>query_filter: the LDAP filter to use</li>
     <li>result_attribute: The name of the attribute to look at in the query result</li>
     <li>scope (default "sub"): The search scope. Can be sub, base or one.</li>
     <li>multiple_result (default "first"): How to handle multiple values in the
     resulting attribute. Can be "first", use the first attribute or "random", pick
     a random one (for e.g. load balancing).</li>
    </ul>
    <p>Both search_base and query_filter are expanded. In profilemap %u expands to the username
    and in locationmap %p expands to the profile name. In both maps %h expands to the full
    hostname of the client, and %% expands to %.</p>
    <h4>Examples</h4>
    <p>There are many way to set up the sabayon LDAP integration. Here are some examples,
    all using the sabayon LDAP schema that comes in the sabayon package.</p>
    <h5>Store profile URL in the user</h5>
    <p>This is the simplest setup. Add a sabayonProfileURLObject to your user objects
    and set the sabayonProfileURL property for each user to a URI of the profile.</p>
    <pre>
  ...    
  &lt;ldap server="..."&gt;
     &lt;profilemap search_base="ou=People,dc=example,dc=com"
                 scope="one"
                 query_filter="(uid=%u)"
                 result_attribute="sabayonProfileURL"/&gt;
  &lt;/ldap&gt;
  ...
    </pre>    
    <h5>Store profile as a separate entity in ldap</h5>
    <p>Store the name of the profile for each user (using a
    sabayonProfileNameObject object), and store the actual URI in
    a sabayonProfile object. This gives a lot of flexibility to change
    the URI of the profile, without having to update each user.</p>
    <pre>
  ...    
  &lt;ldap server="..."&gt;
     &lt;profilemap search_base="ou=People,dc=example,dc=com"
                 scope="one"
                 query_filter="(uid=%u)"
                 result_attribute="sabayonProfileName"/&gt;
     &lt;locationmap search_base="ou=Profiles,dc=example,dc=com"
                  scope="one"
                  query_filter="(cn=%p)"
                  result_attribute="sabayonProfileURL"/&gt;
  &lt;/ldap&gt;
  ...
    </pre>    
    <h5>Pick profile based on group membership</h5>
    <p>This lets you pick a profile based on what group the user
    is part of by adding the sabayonProfileURL attribute to the
    group object.</p>
    <pre>
  ...    
  &lt;ldap server="..."&gt;
     &lt;profilemap search_base="ou=Group,dc=example,dc=com"
                 scope="one"
                 query_filter="(memberUid=%u)"
                 result_attribute="sabayonProfileURL"/&gt;
  &lt;/ldap&gt;
  ...
    </pre>
    <h5>others</h5>
    <p>There are countless other ways, for example you could combine the
    group example and the separate profile object example. If you come up
    with an interesting way, please tell us on the mailing list.</p>
    
    <h2> <a name="format">The profile files format</a> </h2>
    <p> The following is a description of the requirement and the choices
    made when designing the user profile files. The existing format may
    change in the future but unless some of the requirement were missing
    it seems the existing choice is simple and flexible enough that no
    big change should be needed in the future.</p>
    <h4>Format requirements</h4>
    <ul>
      <li> incremental update</li>
      <li> container for sets of settings of different apps</li>
      <li> associate apps with settings</li>
      <li> independent update of one set of settings</li>
      <li> ability to store full file</li>
      <li> ability to save path with the content</li>
      <li> provide metadata for the whole set and for each apps settings</li>
      <li> possibility to merge and detect potential clashes on merges</li>
      <li> possibility to extract or remove a simple set of data</li>
      <li> allow to process with as standard tools as possible </li>
    </ul>
    <h4>Design choices</h4>
    <p>Use ZIP for the container format:</p>
    <ul>
      <li> platform ubiquity Linux/Windows/Mac...</li>
      <li> free software tools and libraries</li>
      <li> compressed</li>
      <li> allows to access a single stream without exploding everything like a compressed tar or cpio requires</li>
      <li> allow to store name/paths</li>
    </ul>
    <p>Add an XML metadata section as the first entry:</p>
    <ul>
      <li> classic design (jar)</li>
      <li> allow to store all metadata informations associated</li>
      <li> easy to extend in a backward and forward compatible way</li>
      <li> open source tools and local knowledge</li>
      <li> a lot of configuration data already require XML handling so this doesn't add an extra dependancy</li>
      <li> load/modify subpart/save operations are easy on an XML tree</li>
    </ul>
    <h4>Internal structure</h4>
    <p> The container is a Zip, its content can be viewed using the command
    <b>unzip -l /etc/desktop-profiles/test.zip</b></p>
    <p> The first entry is the metadata part, it is an XML file describing the
    content of the archive. It can be viewed using the command
    <b>unzip -p /etc/desktop-profiles/test.zip metadata</b>:</p>
    <ul>
      <li> general description for the whole set of settings e.g. "Configuration for developers in project foo":
        <ul>
	  <li> administrative informations</li>
	  <li> last change timestamp</li>
	  <li> contact</li>
	  <li> changelog</li>
	</ul>
      </li>
      <li> per stream description
        <ul>
	  <li> name of the stream in the archive</li>
	  <li> associated application</li>
	  <li> description for settings e.g. "Mozilla starts full screen"</li>
	  <li> administrative info</li>
	</ul>
      </li>
    </ul>
    <p> Then in the ZIP, each update has its own stream, the format is left to
    the corresponding user profile writer module. It can potentially be a
    full raw file, or a more synthetic description recognized by the specific
    profile module.</p>
    <p> Note that an application can have one
    stream per different configuration file for example
    .rhopenoffice1.1/user/registry/data/org/openoffice/Inet.xcu and
    .rhopenoffice1.1/user/registry/data/org/openoffice/Office/Common.xcu
    would be 2 different streams maintained by the OpenOffice reader
    writer module. An application may have both raw configuration files
    and digested name/values pairs, but in different files. </p>
  </body>
</html>
